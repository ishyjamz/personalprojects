/*
Deployment script for FerriesDatabase

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "FerriesDatabase"
:setvar DefaultFilePrefix "FerriesDatabase"
:setvar DefaultDataPath "C:\Users\DeveloperTraining\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB\"
:setvar DefaultLogPath "C:\Users\DeveloperTraining\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Dropping Check Constraint [dbo].[CK_ScheduleStop_ArrivalDay]...';


GO
ALTER TABLE [dbo].[ScheduleStop] DROP CONSTRAINT [CK_ScheduleStop_ArrivalDay];


GO
PRINT N'Dropping Check Constraint [dbo].[CK_ScheduleStop_DepartureDay]...';


GO
ALTER TABLE [dbo].[ScheduleStop] DROP CONSTRAINT [CK_ScheduleStop_DepartureDay];


GO
PRINT N'Creating Check Constraint [dbo].[CK_ScheduleStop_ArrivalDay]...';


GO
ALTER TABLE [dbo].[ScheduleStop] WITH NOCHECK
    ADD CONSTRAINT [CK_ScheduleStop_ArrivalDay] CHECK (ArrivalDay BETWEEN 0 AND 6);


GO
PRINT N'Creating Check Constraint [dbo].[CK_ScheduleStop_DepartureDay]...';


GO
ALTER TABLE [dbo].[ScheduleStop] WITH NOCHECK
    ADD CONSTRAINT [CK_ScheduleStop_DepartureDay] CHECK (DepartureDay BETWEEN 0 AND 6);


GO
PRINT N'Altering Procedure [dbo].[usp_Company_Delete]...';


GO
/*===========================================================================*\ 
Description: 
Deletes existing company 

Parameters: 
@CompanyId

Created:    February 2023
\*===========================================================================*/
ALTER PROCEDURE dbo.usp_Company_Delete
@CompanyId INT

AS
BEGIN
DELETE 
FROM   dbo.Company
WHERE  CompanyId = @CompanyId

END
GO
PRINT N'Altering Procedure [dbo].[usp_Company_Get]...';


GO
/*===========================================================================*\ 
Description: 
Retrieves company details which correspond to inputted company ID

Parameters: 
@CompanyId

Created:    February 2023
\*===========================================================================*/
ALTER PROCEDURE dbo.usp_Company_Get (
@CompanyId INT)

AS 
BEGIN 
SELECT  CompanyId, Name, RowVersion
FROM    dbo.Company
WHERE   CompanyId = @CompanyId
END
GO
PRINT N'Altering Procedure [dbo].[usp_Company_Insert]...';


GO
/*===========================================================================*\ 
Description: 
Creates new company in database

Parameters: 
@Name       NVARCHAR(256)
@CompanyId  INT OUTPUT

Created:    January 2023
\*===========================================================================*/
ALTER PROCEDURE dbo.usp_Company_Insert
@Name       NVARCHAR(256),
@CompanyId  INT OUTPUT


AS 
INSERT dbo.Company (
Name)

VALUES (
@Name)

SELECT @CompanyId = SCOPE_IDENTITY()
GO
PRINT N'Altering Procedure [dbo].[usp_Company_List]...';


GO
/*===========================================================================*\ 
Description: 
Lists all the companies in a database
Created:    February 2023
\*===========================================================================*/

ALTER PROCEDURE dbo.usp_Company_List

AS 
BEGIN
SELECT CompanyId, Name
FROM dbo.Company
END
GO
PRINT N'Altering Procedure [dbo].[usp_Company_ListFerry]...';


GO
/*===========================================================================*\ 
Description: 
Lists all the ferries for one company
Parameters: 
@CompanyId INT

Created:    February 2023
\*===========================================================================*/

ALTER PROCEDURE dbo.usp_Company_ListFerry
@CompanyId INT

AS 
BEGIN
SELECT FerryId, Name, CompanyId
FROM   dbo.Ferry
WHERE  CompanyId = @CompanyId
END
GO
PRINT N'Altering Procedure [dbo].[usp_Company_Update]...';


GO
/*===========================================================================*\ 
Description: 
Updates details for existing company 

Parameters: 
@CompanyId  INT,
@Name       NVARCHAR(256)
@RowVersion ROWVERSION

Created:    February 2023
\*===========================================================================*/

ALTER PROCEDURE dbo.usp_Company_Update
(@CompanyId  INT,
 @Name       NVARCHAR(256),
 @RowVersion ROWVERSION)

AS 
BEGIN 
UPDATE dbo.Company
SET    Name = @Name
WHERE  (CompanyId = @CompanyId) AND (RowVersion = @RowVersion)
END
GO
PRINT N'Altering Procedure [dbo].[usp_Ferry_Delete]...';


GO
/*===========================================================================*\ 
Description: 
Deletes existing ferry

Parameters: 
@FerryId

Created:    February 2023
\*===========================================================================*/

ALTER PROCEDURE dbo.usp_Ferry_Delete
@FerryId INT

AS
BEGIN
DELETE 
FROM   dbo.Ferry
WHERE  FerryId = @FerryId
END
GO
PRINT N'Altering Procedure [dbo].[usp_Ferry_Get]...';


GO
/*===========================================================================*\ 
Description: 
Retrieves ferry details for specified ferry

Parameters: 
@FerryId  INT

Created:    February 2023
\*===========================================================================*/

ALTER PROCEDURE dbo.usp_Ferry_Get (
@FerryId INT)

AS 
BEGIN 
SELECT  FerryId, CompanyId, Name, RowVersion
FROM    dbo.Ferry
WHERE   FerryId = @FerryId
END
GO
PRINT N'Altering Procedure [dbo].[usp_Ferry_Insert]...';


GO
/*===========================================================================*\ 
Description: 
Creates new ferry in database

Parameters: 
@Name       NVARCHAR(256),
@CompanyId  INT,
@FerryId    INT OUTPUT

Created:    February 2023
\*===========================================================================*/
ALTER PROCEDURE dbo.usp_Ferry_Insert
@Name       NVARCHAR(256),
@CompanyId  INT,
@FerryId    INT OUTPUT

AS 
INSERT dbo.Ferry (
Name,
CompanyId)

VALUES (
@Name,
@CompanyId)

SELECT @FerryId = SCOPE_IDENTITY()
GO
PRINT N'Altering Procedure [dbo].[usp_Ferry_List]...';


GO
/*===========================================================================*\ 
Description: 
Lists all the ferries in a database
Created:    February 2023
\*===========================================================================*/
ALTER PROCEDURE dbo.usp_Ferry_List

AS 
BEGIN
SELECT FerryId, Name, CompanyId
FROM dbo.Ferry
END
GO
PRINT N'Altering Procedure [dbo].[usp_Ferry_ListSchedules]...';


GO
/*===========================================================================*\ 
Description: 
Lists all the schedules for one ferry
Parameters: 
@FerryId INT

Created:    February 2023
\*===========================================================================*/
ALTER PROCEDURE dbo.usp_Ferry_ListSchedules
@FerryId INT

AS 
BEGIN
SELECT ScheduleId, Description, CostPerPerson, CostPerVehicle
FROM   dbo.Schedule
WHERE  FerryId = @FerryId
END
GO
PRINT N'Altering Procedure [dbo].[usp_Ferry_Update]...';


GO
/*===========================================================================*\ 
Description: 
Updates details for existing ferry 

Parameters: 
@FerryId    INT,
@Name       NVARCHAR(256),
@CompanyId  INT,
@RowVersion ROWVERSION

Created:    February 2023
\*===========================================================================*/
ALTER PROCEDURE dbo.usp_Ferry_Update
(@FerryId    INT,
 @CompanyId  INT,
 @Name       NVARCHAR(256),
 @RowVersion ROWVERSION)

AS 
BEGIN 
UPDATE dbo.Ferry
SET    Name = @Name, CompanyId = @CompanyId
WHERE  (FerryId = @FerryId) AND (RowVersion = @RowVersion)
END
GO
PRINT N'Altering Procedure [dbo].[usp_Schedule_Delete]...';


GO
/*===========================================================================*\ 
Description: 
Deletes existing schedule

Parameters: 
@ScheduleId INT

Created:    February 2023
\*===========================================================================*/
ALTER PROCEDURE dbo.usp_Schedule_Delete
@ScheduleId INT

AS
BEGIN
DELETE 
FROM   dbo.Schedule
WHERE  ScheduleId = @ScheduleId
END
GO
PRINT N'Altering Procedure [dbo].[usp_Schedule_Get]...';


GO
/*===========================================================================*\ 
Description: 
Retrieves schedule details for specified schedule

Parameters: 
@ScheduleId  INT

Created:    February 2023
\*===========================================================================*/
ALTER PROCEDURE dbo.usp_Schedule_Get (
@ScheduleId INT)

AS 
BEGIN 
SELECT  FerryId, Description, CostPerPerson, CostPerVehicle, RowVersion
FROM    dbo.Schedule
WHERE   ScheduleId = @ScheduleId
END
GO
PRINT N'Altering Procedure [dbo].[usp_Schedule_Insert]...';


GO
/*===========================================================================*\ 
Description: 
Creates new schedule in database

Parameters: 
@Name       NVARCHAR(256),
@CompanyId  INT,
@FerryId    INT OUTPUT

Created:    February 2023
\*===========================================================================*/
ALTER PROCEDURE dbo.usp_Schedule_Insert
@FerryId        INT,
@Description    NVARCHAR(256),
@CostPerPerson  DECIMAL(9,2),
@CostPerVehicle DECIMAL(9,2),
@ScheduleId     INT OUTPUT

AS 
INSERT dbo.Schedule(
FerryId,
Description,
CostPerPerson,
CostPerVehicle)

VALUES (
@FerryId,
@Description,
@CostPerPerson,
@CostPerVehicle)

SELECT @ScheduleId = SCOPE_IDENTITY()
GO
PRINT N'Altering Procedure [dbo].[usp_Schedule_Update]...';


GO
/*===========================================================================*\ 
Description: 
Updates details for existing schedule

Parameters: 
 @ScheduleId     INT,
 @FerryId        INT,
 @Description    NVARCHAR(256),
 @CostPerPerson  DECIMAL(9,2),
 @CostPerVehicle DECIMAL(9,2),
 @RowVersion     ROWVERSION

Created:    February 2023
\*===========================================================================*/
ALTER PROCEDURE dbo.usp_Schedule_Update
(@ScheduleId     INT,
 @FerryId        INT,
 @Description    NVARCHAR(256),
 @CostPerPerson  DECIMAL(9,2),
 @CostPerVehicle DECIMAL(9,2),
 @RowVersion     ROWVERSION)

AS 
BEGIN 
UPDATE dbo.Schedule
SET    FerryId = @FerryId, Description = @Description, CostPerPerson = @CostPerPerson, CostPerVehicle = @CostPerVehicle
WHERE  (ScheduleId = @ScheduleId) AND (RowVersion = @RowVersion)
END
GO
PRINT N'Creating Procedure [dbo].[dummy]...';


GO
CREATE PROCEDURE [dbo].[dummy]
	@param1 int = 0,
	@param2 int
AS
	SELECT @param1, @param2
RETURN 0
GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[ScheduleStop] WITH CHECK CHECK CONSTRAINT [CK_ScheduleStop_ArrivalDay];

ALTER TABLE [dbo].[ScheduleStop] WITH CHECK CHECK CONSTRAINT [CK_ScheduleStop_DepartureDay];


GO
PRINT N'Update complete.';


GO
